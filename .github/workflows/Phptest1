name: PHP 8 Compatibility Check

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]
  workflow_dispatch:

jobs:
  php-tests:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    strategy:
      matrix:
        php-version: ['8.0', '8.1', '8.2']

    steps:
    - uses: actions/checkout@v4
    
    - name: Setup PHP ${{ matrix.php-version }}
      uses: shivammathur/setup-php@v2
      with:
        php-version: ${{ matrix.php-version }}
        tools: none
        coverage: none

    - name: Create temporary composer.json
      if: ! -f composer.json
      run: echo '{"require-dev":{"phpcompatibility/php-compatibility":"*"}}' > composer.json

    - name: Install PHPCompatibility
      run: |
        composer require --dev phpcompatibility/php-compatibility --no-interaction --no-progress
        ./vendor/bin/phpcs --config-set installed_paths vendor/phpcompatibility/php-compatibility

    - name: Run Compatibility Check
      run: ./vendor/bin/phpcs . --standard=PHPCompatibility --runtime-set testVersion 8.0- --ignore=*/vendor/*

    - name: PHP Syntax Check
      run: find . -type f -name "*.php" -not -path "*/vendor/*" | xargs -n 1 php -l
